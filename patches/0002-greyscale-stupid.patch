From c745201f87409b06b57731049b8c8cb2824a9a82 Mon Sep 17 00:00:00 2001
From: Dafna Hirschfeld <dafna3@gmail.com>
Date: Thu, 18 Oct 2018 20:34:54 +0300
Subject: [PATCH 2/2] greyscale stupid

---
 drivers/media/platform/vicodec/codec-fwht.c      | 13 ++++++++++---
 drivers/media/platform/vicodec/codec-v4l2-fwht.c | 10 ++++++++++
 drivers/media/platform/vicodec/vicodec-core.c    |  6 ++++++
 3 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/drivers/media/platform/vicodec/codec-fwht.c b/drivers/media/platform/vicodec/codec-fwht.c
index 6a496feef5d2..a40dea78be41 100644
--- a/drivers/media/platform/vicodec/codec-fwht.c
+++ b/drivers/media/platform/vicodec/codec-fwht.c
@@ -758,9 +758,11 @@ u32 fwht_encode_frame(struct fwht_raw_frame *frm,
 	u32 encoding;
 	u32 chroma_h = frm->height / frm->height_div;
 	u32 chroma_w = frm->width / frm->width_div;
-	//if (!frm->cr || !frm->cb) {
-	//	chroma_h = chroma_w = 0;
-	//}
+	pr_info("dafna: %s: frm->cr = %p frm->cb = %p\n",__func__, frm->cr, frm->cb);
+	if (!frm->cr || !frm->cb) {
+		pr_info("dafna: %s: setting chroma_[wh] to 0\n",__func__);
+		chroma_h = chroma_w = 0;
+	}
 	
 	unsigned int chroma_size = chroma_h * chroma_w;
 
@@ -864,8 +866,13 @@ void fwht_decode_frame(struct fwht_cframe *cf, struct fwht_raw_frame *ref,
 		h *= 2;
 	if (hdr_flags & FWHT_FL_CHROMA_FULL_WIDTH)
 		w *= 2;
+	
 	decode_plane(cf, &rlco, ref->luma, cf->height, cf->width,
 		     hdr_flags & FWHT_FL_LUMA_IS_UNCOMPRESSED);
+	if(!ref->cb || !ref->cr) {
+		pr_info("dafna: %s: !cr or !cb, setting w=h=0\n",__func__);
+		w = h = 0;
+	}
 	decode_plane(cf, &rlco, ref->cb, h, w,
 		     hdr_flags & FWHT_FL_CB_IS_UNCOMPRESSED);
 	decode_plane(cf, &rlco, ref->cr, h, w,
diff --git a/drivers/media/platform/vicodec/codec-v4l2-fwht.c b/drivers/media/platform/vicodec/codec-v4l2-fwht.c
index 121492a33647..33382a603c32 100644
--- a/drivers/media/platform/vicodec/codec-v4l2-fwht.c
+++ b/drivers/media/platform/vicodec/codec-v4l2-fwht.c
@@ -11,6 +11,7 @@
 #include "codec-v4l2-fwht.h"
 
 static const struct v4l2_fwht_pixfmt_info v4l2_fwht_pixfmts[] = {
+	{ V4L2_PIX_FMT_GREY,    1, 1, 1, 1, 0, 1, 1 },
 	{ V4L2_PIX_FMT_YUV420,  1, 3, 2, 1, 1, 2, 2 },
 	{ V4L2_PIX_FMT_YVU420,  1, 3, 2, 1, 1, 2, 2 },
 	{ V4L2_PIX_FMT_YUV422P, 1, 2, 1, 1, 1, 2, 1 },
@@ -74,6 +75,12 @@ int v4l2_fwht_encode(struct v4l2_fwht_state *state, u8 *p_in, u8 *p_out)
 
 	pr_info("dafna: %s: V4L2_PIX_FMT is %u\n",__func__, info->id);
 	switch (info->id) {
+	case V4L2_PIX_FMT_GREY:
+		pr_info("dafna: %s: GREY case\n",__func__);
+		rf.cb = rf.cr = NULL;
+		pr_info("dafna: %s: fr.cr = %p fr.cb = %p\n",__func__, 
+				rf.cr, rf.cb);
+		break;	
 	case V4L2_PIX_FMT_YUV420:
 		rf.cb = rf.luma + size;
 		rf.cr = rf.cb + size / 4;
@@ -249,6 +256,9 @@ int v4l2_fwht_decode(struct v4l2_fwht_state *state, u8 *p_in, u8 *p_out)
 	fwht_decode_frame(&cf, &state->ref_frame, flags);
 
 	switch (state->info->id) {
+	case V4L2_PIX_FMT_GREY:
+		memcpy(p_out, state->ref_frame.luma, size);
+		break;
 	case V4L2_PIX_FMT_YUV420:
 	case V4L2_PIX_FMT_YUV422P:
 		memcpy(p_out, state->ref_frame.luma, size);
diff --git a/drivers/media/platform/vicodec/vicodec-core.c b/drivers/media/platform/vicodec/vicodec-core.c
index d53723eac40f..4b7f7d3d4d97 100644
--- a/drivers/media/platform/vicodec/vicodec-core.c
+++ b/drivers/media/platform/vicodec/vicodec-core.c
@@ -1045,6 +1045,12 @@ static int vicodec_start_streaming(struct vb2_queue *q,
 	}
 	state->ref_frame.cb = state->ref_frame.luma + size;
 	state->ref_frame.cr = state->ref_frame.cb + size / chroma_div;
+	
+	if(info->id == V4L2_PIX_FMT_GREY) {
+		pr_info("dafna: %s ctx=%p, id is grey, setting cb cr to NULL\n",__func__, ctx);
+		state->ref_frame.cb = NULL;
+		state->ref_frame.cr = NULL;
+	}
 	ctx->last_src_buf = NULL;
 	ctx->last_dst_buf = NULL;
 	state->gop_cnt = 0;
-- 
2.17.1

